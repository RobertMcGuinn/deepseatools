---
title: "Area of Interest Report"
author: "Robert P. McGuinn"
date: "`r Sys.Date()`"
output: 
  word_document:
    reference_docx: "c:/rworking/deepseatools/code/template.docx"
editor_options: 
  chunk_output_type: console
---

```{r packages, echo=F, message=FALSE, warning=FALSE, cache=FALSE, eval=T}
## load packages
#install.packages(tidyverse)
#install.packages('openxlsx')
# install.packages("ggspatial")
# install.packages("prettymapr")
library(prettymapr)
library(ggspatial)
library(tidyverse)
library(openxlsx)
library(sf)
library(RColorBrewer)
library(raster)
library(leaflet)
library(extrafont)
loadfonts()
library(RColorBrewer)
library(rmarkdown)
library(knitr)
library(maps)
library(raster)
library(httr)
library(jsonlite)
# install.packages('rnaturalearth')
library(rnaturalearth)
library(rnaturalearthdata)
library(openxlsx)
library(googledrive)
library(spocc)
library(terra)
library(knitr)
library(kableExtra)
library(marmap)

```

```{r chunk_options, include=FALSE, eval=T}
knitr::opts_chunk$set(echo = FALSE, 
                      fig.height = 4.5,
                      fig.width = 7.5 
                      )
```

```{r load_NDB, echo=F, message=FALSE, warning=FALSE, cache=F, eval=T}
## load NDB
source('c:/rworking/deepseatools/code/mod_load_current_NDB.R')

```

```{r set_run_variables, echo=F, eval=T}
##### create variables ##### 
db_version <- unique(filt$DatabaseVersion)
aoi_name <- "Aleutian Islands - West"
drive_link <- "https://drive.google.com/drive/folders/1BTvCPfE0W1-ZnNSPycIm_j4r-0WoftPo?usp=drive_link"
redmine_link <- "https://vlab.noaa.gov/redmine/issues/146547"
file_name <- "20250530_Aleutian_aoi_AWeinnig.Rmd"
github_link <- paste0("https://github.com/RobertMcGuinn/deepseatools/blob/master/code/", file_name)
gebco_date <- "2024-05-23"

```

```{r load_dives, echo=F, message = FALSE, warning = FALSE, cache = TRUE, eval = T}
##### load dives ##### 
digits = 12
codepath <- "c:/rworking/deepseatools/indata/"
dives <- read.csv(paste0(codepath,'AT50_38_Dive_targets_Draft_21Jan25.csv'))

###### cleanup ###### 
dives <- dives %>% filter(is.na(Latitude) == F)

##### create sf object ##### 
dives_sf <- st_as_sf(dives, coords = c("Longitude", "Latitude"), crs = 4326)
bbox <- st_bbox(dives_sf)

dives_poly <- st_as_sfc(bbox)

##### check ##### 
# class(dives_sf)
# names(dives)
# View(dives)
# hist(dives$Longitude)
# summary(dives$Longitude, digits = 10)

```

```{r load_GEBCO_2024_data_and_reclass, echo=FALSE, echo = F, message = FALSE, warning=FALSE, results = "hide", eval=T}
## get data from here: https://download.gebco.net/ (acquired 20250404)
## use this bounding box to subset
##  West	East	South	North
#   xmin      ymin      xmax      ymax 
# -179.9482   51.5700 -168.0150   53.9826 

gebco_2024_bathy <- rast("C:/rworking/deepseatools/indata/gebco_2024_n55.0_s50.0_w-180.0_e-167.0.tif")

# Define reclassification matrix for negative depth values
rcl_matrix <- matrix(c(
  -9999, -3000, 13,
  -3000, -2750, 12,
  -2750, -2500, 11,
  -2500, -2250, 10,
  -2250, -2000, 9,
  -2000, -1750, 8,
  -1750, -1500, 7,
  -1500, -1250, 6,
  -1250, -1000, 5,
  -1000, -750, 4,
  -750, -500, 3,
  -500, -250, 2,
  -250, 0, 1,
  0, 2000, -999
), ncol = 3, byrow = TRUE)

# rcl_matrix <- matrix(c(
#   -9999, -3000, 7,
#   -3000, -2500, 6,
#   -2500, -2000, 5,
#   -2000, -1500, 4,
#   -750, -500, 3,
#   -500, -250, 2,
#   -250, 0, 1, 
#   0, 1000, -999
# ), ncol = 3, byrow = TRUE)

# Perform reclassification
gebco_2024_bathy_reclass <- classify(gebco_2024_bathy, rcl_matrix)

##### write the combined raster for visualization ##### 
writeRaster(
  gebco_2024_bathy_reclass,
  filename = "c:/rworking/deepseatools/indata/gebco_2024_bathy_reclass_250.tif",
  datatype = "INT2S",        # Ensures integer data
  overwrite = TRUE
)

# summary(gebco_2024_bathy_reclass)
# summary(gebco_2024_bathy)

```

```{r load_aoi, echo=FALSE, echo = F, message = FALSE, warning=FALSE, results = "hide", eval=T }

##### get the bounding box for aleutians ##### 
aoi <- as.polygons(ext(gebco_2024_bathy), crs = crs(gebco_2024_bathy))

##### covert to sf object ##### 
aoi <- st_as_sf(aoi)

##### reproject to target crs ##### 
aoi_transform <- st_transform(aoi, crs = 3338)

##### Write to (for mapping) #####
aoi_transform_spat <- vect(aoi_transform)
writeVector(aoi_transform_spat, "C:/rworking/deepseatools/indata/aoi_transform.shp", overwrite = TRUE)

##### check ##### 
# View(aoi)
# st_bbox(aoi)

```

```{r split_aoi, echo=FALSE, echo = F, message = FALSE, warning=FALSE, results = "hide", eval=T }

split_bbox_vertically <- function(bbox_sfc, n = 3) {
  bbox_coords <- st_bbox(bbox_sfc)
  
  width <- (bbox_coords["xmax"] - bbox_coords["xmin"]) / n
  polys <- lapply(0:(n-1), function(i) {
    xmin <- bbox_coords["xmin"] + i * width
    xmax <- xmin + width
    st_polygon(list(rbind(
      c(xmin, bbox_coords["ymin"]),
      c(xmax, bbox_coords["ymin"]),
      c(xmax, bbox_coords["ymax"]),
      c(xmin, bbox_coords["ymax"]),
      c(xmin, bbox_coords["ymin"])
    ))) %>% st_sfc(crs = st_crs(bbox_sfc))
  })
  
  st_sf(geometry = do.call(c, polys))
}

aoi3 <- split_bbox_vertically(aoi)
aoi_west <- aoi3[1,]
aoi_central <- aoi3[2,]
aoi_east <- aoi3[3,]

##### write for maps ##### 
write_sf(aoi_west, "c:/rworking/deepseatools/indata/aoi_west.shp")
write_sf(aoi_east, "c:/rworking/deepseatools/indata/aoi_east.shp")
write_sf(aoi_central, "c:/rworking/deepseatools/indata/aoi_central.shp")

```

```{r plot_aois, echo=FALSE, echo = F, message = FALSE, warning=FALSE, results = "hide", eval=F }

# Add a name column to each sf object
aoi_west <- aoi_west %>% mutate(name = "aoi_west")
aoi_central <- aoi_central %>% mutate(name = "aoi_central")
aoi_east <- aoi_east %>% mutate(name = "aoi_east")

# Combine them into one sf object
aoi_combined <- rbind(aoi_west, aoi_central, aoi_east)

# Get centroids as points for labels
centroids <- st_centroid(aoi_combined)


land <- ne_countries(scale = "medium", returnclass = "sf")
bbox <- st_bbox(aoi_combined)

library(ggrepel)


ggplot() +
  geom_sf(data = land, fill = "gray80", color = NA) +  
  geom_sf(data = aoi_combined, aes(fill = name), color = "black", alpha = 0.5) +
  geom_sf(data = dives_sf, color = "red", size = 2, shape = 21, fill = "yellow") +
  ggrepel::geom_text_repel(
    data = dives_sf,
    aes(geometry = geometry, label = site),
    stat = "sf_coordinates",
    size = 3,
    fontface = "italic",
    color = "darkblue",
    nudge_y = 0.01,
    min.segment.length = 0
  ) +
  coord_sf(
    xlim = c(bbox["xmin"], bbox["xmax"]),
    ylim = c(bbox["ymin"], bbox["ymax"]),
    expand = FALSE
  ) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Split Bounding Box with Dive Points and Land Background",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme(
    axis.text.y = element_text(color = "black", size = 10),
    axis.ticks.y = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.text.x = element_text(color = "black", size = 10),
    axis.ticks.x = element_line(color = "black"),
    axis.line.x = element_line(color = "black"),
    legend.position = "none"
  )



```

```{r filter_occurrences_by_geography_and_create_sf_object, echo=F, warning=F, message=F, eval=T}
##### filter occurrences by query or box or both ##### 
## set bounding box variables
library(sf)

# Get the bounding box of the polygon
bbox <- st_bbox(aoi)

# Extract min/max lat/lon
minlon <- bbox["xmin"]
maxlon <- bbox["xmax"]
minlat <- bbox["ymin"]
maxlat <- bbox["ymax"]

## subset data by coordinates
x <- subset(filt, as.numeric(Latitude) > minlat &
                   as.numeric(Latitude) < maxlat &
                   as.numeric(Longitude) > minlon &
                   as.numeric(Longitude) < maxlon)
                
## create sf files
points <- st_as_sf(x, coords = c("Longitude", "Latitude"), crs = 4326)

## cleanup
rm(x)

## OPTIONAL - write points 
# write_sf(points, "c:/rworking/deepseatools/indata/points.shp")

##### check ##### 
points %>% filter(grepl("EX", DatasetID)) %>% pull(SurveyID)

opoints %>% group_by(DatasetID, SurveyID) %>% summarize(Number_Records=n()) %>% View()


```

```{r intersect_reclass_raster_values_to points within aoi , echo=F, eval=T}
## convert sf object to SpatVector for terra
points_vect <- vect(points)

## extract values
extracted <- extract(gebco_2024_bathy_reclass, points_vect)

## add extracted values to the original point data
points$Classes <- extracted[, 2]  # The second column usually holds the raster values

```

# Area of Interest (AOI): `r aoi_name`
# Purpose of Report

To create summaries of coral, sponge, and fish presence data from NOAA's National Database for Deep-sea Corals and Sponges to support decision making in the deep-sea regions of `r aoi_name`.  

# Resources

- [Google drive folder containing inputs, code, and reports](`r drive_link`)

- [RMarkdown code for generating this report](`r github_link`)

- [NOAA's National Database for Deep-sea Corals and Sponges portal](https://www.ncei.noaa.gov/maps/deep-sea-corals-portal/) 

- [Redmine tracker](`r redmine_link`) (for internal reference)

# Analysis Notes

Coral, sponge, and fish occurrences from NOAA's National Database for Deep-sea Corals and Sponges are summarized within the `r aoi_name`. The database version used in this report is `r unique(filt$DatabaseVersion)`. *Important interpretive note:* The database is presence-only. Geographic areas containing no occurrences may have not have been explored, or, alternatively, the results of that exploration are not contained within this database. This database does not record absences.  

One area of interest is defined for the purposes of this report:   

- AOI = `r aoi_name`

Bathymetric data displayed in the included maps:

- GEBCO 2024. https://download.gebco.net/. Acquired `r gebco_date`.

\newpage

# Map 

```{r include_map, echo=F, eval=T}
knitr::include_graphics("c:/rworking/deepseatools/images/ak/layout.tif")

```

\newpage

# Results
#### Figure and Table 1: 0-250m
``` {r depth_bin_table__1, echo=FALSE, message=F, eval=T}
##### set depth bins #####
i <- 0
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl



```

\newpage
#### Figure and Table 2: 250-500m
``` {r depth_bin_table__2, echo=FALSE, eval=T}
##### set depth bins #####
i <- 250
mindepth <- i
maxdepth <- i+250
bin_data <- points %>%  
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl



```
\newpage
#### Figure and Table 3: 500-750m
```{r depth_bin_table__3, echo=FALSE, eval=T}
##### set depth bins #####
i <- 500
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 4: 750-1000m
```{r depth_bin_table__4, echo=FALSE, eval=T}
##### set depth bins #####
i <- 750
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 5: 1000-1250m
```{r depth_bin_table__5, echo=FALSE, eval=T}
##### set depth bins #####
i <- 1000
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 6: 1250-1500m
```{r depth_bin_table__6_echo=FALSE, eval=T}
##### set depth bins #####
i <- 1250
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 7: 1500-1750m
```{r depth_bin_table__7, echo=FALSE, eval=T}
##### set depth bins #####
i <- 1500
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 8: 1750-2000m
```{r depth_bin_table__8, echo=FALSE, eval=T}
##### set depth bins #####
i <- 1750
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 9: 2000-2250m
```{r depth_bin_table__9, echo=FALSE, eval=T}
##### set depth bins #####
i <- 2000
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl

```
\newpage
#### Figure and Table 10: 2250-2500m
```{r depth_bin_table__10, echo=FALSE, eval=T}
##### set depth bins #####
i <- 2250
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 11: 2500-2750m
```{r depth_bin_table__11, echo=FALSE, eval=T}
##### set depth bins #####
i <- 2500
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 12: 2750-3000m
```{r depth_bin_table__12, echo=FALSE, eval=T}
##### set depth bins #####
i <- 2750
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 13: 3000-3250m
```{r depth_bin_table__13, echo=FALSE, eval=T}
##### set depth bins #####
i <- 3000
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 14: 3250-3500m
```{r depth_bin_table__14, echo=FALSE, eval=T}
##### set depth bins #####
i <- 3250
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 15: 3500-3750m
```{r depth_bin_table__15, echo=FALSE, eval=T}
##### set depth bins #####
i <- 3500
mindepth <- i
maxdepth <- i+250
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```
\newpage
#### Figure and Table 16: 3750-4500m
```{r depth_bin_table__16, echo=FALSE, eval=T}
##### set depth bins #####
i <- 3750
mindepth <- i
maxdepth <- i+750
bin_data <- points %>% 
filter(DepthInMeters > mindepth, DepthInMeters <= maxdepth)

##### assigning IndividualCount #####
bin_data <- bin_data %>%
  mutate(IndividualCount = case_when(
    IndividualCount == -999 ~ 1,
    TRUE ~ IndividualCount
  ))


##### set color choices ##### 
my_colors <- c(
  "stony coral (branching)" =  "#FFFFFF",
  "stony coral (cup coral)" =  "#00E6A9",
  "black coral" =  "#000000",
  "gorgonian coral" = "#FF0000",
  "soft coral" =  "#00734C",
  "sea pen" = "#0000FF",
  "stoloniferan coral" = "#7F7F7F",
  "lace coral" = "#A80084",
  "lithotelestid coral" = "#FF00C5",
  "stony coral (unspecified)" = "#D1FF73",
  "gold coral" =  "#FFFF00",
  "sponge (unspecified)" = "#FF0000",
  "demosponge" = "#00FFC5",
  "glass sponge" = "#C500FF",
  "homoscleromorph sponge" = "#FFFF00",
  "calcareous sponge" = "#55FF00",
  "other coral-like hydrozoan" = "#00FFFF",
  "alcyonacean (unspecified)" = "#D7B09E",
  "fish" = "#7a2d0a"
)



##### make a boxplot of VernacularNameCategory within depth bin ##### 
g <- ggplot(bin_data, aes(reorder(VernacularNameCategory, DepthInMeters, FUN = median),
                          DepthInMeters,
                          fill = VernacularNameCategory)) +
  geom_boxplot() +
  scale_y_reverse() +
  coord_cartesian(ylim = c(maxdepth, mindepth)) +  # Explicit y-axis range
  ylab("Depth (meters)") +
  xlab("") +
  ggtitle(sprintf("Depth Distribution by Category (%d-%d m)", mindepth, maxdepth)) +
  theme_bw(base_size = 10, base_family = "sans") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1, face = 'italic'),
    axis.title.y = element_text(margin = margin(r = 30))
  ) +
  scale_fill_manual(values = my_colors) +
  labs(fill = "Vernacular Name Category")

print(g)  # Plot shows in Word

# Summary Table
library(flextable)

tab <- bin_data %>%
  st_drop_geometry() %>%  # Remove spatial component
  group_by(VernacularNameCategory) %>%
  summarise(
    Individuals = sum(IndividualCount),
    MinDepth = min(DepthInMeters, na.rm = TRUE),
    MedianDepth = median(DepthInMeters, na.rm = TRUE),
    MaxDepth = max(DepthInMeters, na.rm = TRUE),
    ScientificNames = paste(sort(unique(ScientificName)), collapse = " / "),
    .groups = "drop"
  ) %>%
  arrange(MedianDepth)

# Create the flextable
sum_tbl <- flextable(tab) %>%
  fontsize(size = 6) %>%  # Set the font size for content
  compose(j = "Individuals", value = as_paragraph(as_chunk(Individuals))) %>%  # Compose column N
  set_table_properties(layout = "autofit") %>%
  bold(part = "header") %>%  # Optionally, make the header bold
  fontsize(part = "header", size = 7) %>%   # Set a smaller font size for the header
  valign(valign = "top")

sum_tbl


```

\newpage


